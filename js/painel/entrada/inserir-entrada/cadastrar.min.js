$(document).ready(function(){var k=false;var j=0;var r={};var t=true;var o=0;var f=0;$("#formContrato").focus(function(){j=$(this).val()}).change(function(){if(j!=0){w(j,$(this).val())}else{d()}});$("#formItemContrato").change(l);m();$("#botaoAdicionar").click(function(){if(!b()){if(t==true){$("#listaVazia").hide()}if(k==false){x();o++;notificacao_sucesso("Item <b>adicionado</b> com sucesso.");g()}else{k=false;n();$("#botaoAdicionar").attr("class","btn btn-default btn-block");$("#botaoAdicionar").html("Adicionar a Lista");notificacao_sucesso("Item <b>editado</b> com sucesso.");g()}m()}});$("#botaoInserirEntrada").click(function(){if(!h()&&!q()){z();$("#modalConfirmacao").modal("show")}});$("#confBotaoEnviar").click(function(){if(!q()){$("#barraProgresso").show();$("#modalTitulo").html("Realizando Cadastro");u()}});$("#dataEntrada").datepicker(formatoData);function x(){var D=$("#formItemContrato option:selected");var C=$("#formQuantidade");var B=$("#formUnidade");var E='<div class="listaItem"><div class="row"><var class="idItemContrato" style="display: none">'+D.val()+'</var><var class="valorQuantidade" style="display: none">'+C.val()+'</var><div class="col-md-4 item" style="margin-top: 5px">'+D.text()+'</div><div class="col-md-4 quantidade" style="margin-top: 5px">'+C.val()+" "+B.html()+'</div><div class="col-md-4"><div class="text-right"><button class="btn btn-default botaoEditar"><i class="fa fa-edit"></i></button><button class="btn btn-danger botaoRemover"><i class="fa fa-trash"></i></button></div></div></div><hr/></div>';$("#listaItens").append(E)}function v(){var B=false;var C=$("#formContrato option:selected").val();$.ajax({url:urlBase+"api/painel/entrada/inserirentrada/itenscontrato?idContrato="+C,type:"get",async:false,success:function(E,D){if(E.sucesso==true){r=E.resposta}},error:function(F,E,D){B=true}})}function w(C,B){$("#modalAlerta").modal("show");$("#botaoAlertaSim").click(function(){$("#formContrato").val(B);A();d()});$("#botaoAlertaNao").click(function(){$("#formContrato").val(C);d()})}function d(){v();var D=$("#formItemContrato");var B='<option value="0">Item</option>';for(var C in r){if(r.hasOwnProperty(C)){B+='<option value="'+r[C].id_item_contrato+'">'+r[C].nome+"</option>"}}D.empty();D.html(B)}function l(){var B=$("#formItemContrato option:selected").val();var D=false;for(var C in r){if(r.hasOwnProperty(C)&&r[C]["id_item_contrato"]==B){$("#formUnidade").html(unidades[r[C]["unidade_padrao_id"]]["nome"]);D=true;break}}if(!D){$("#formUnidade").empty()}}function n(){var D=$("#formItemContrato option:selected");var C=$("#formQuantidade");var B=$("#formUnidade");$($(".idItemContrato")[f]).html(D.val());$($(".valorQuantidade")[f]).html(C.val());$($(".item")[f]).html(D.text());$($(".quantidade")[f]).html(C.val()+" "+B.html())}function u(){var D=$("#formContrato option:selected").val();var C=$("#formNumeroNota").val();var B=$("#formDataEntrada").val();var E=[];$('var[class="idItemContrato"]').each(function(G,F){if(!E.hasOwnProperty(G)){E[G]={idContrato:D,numeroNota:C,dataEntrada:B}}E[G][$(this).attr("class")]=$(this).html()});$('var[class="valorQuantidade"]').each(function(G,F){if(!E.hasOwnProperty(G)){E[G]={idContrato:D,numeroNota:C,dataEntrada:B}}E[G][$(this).attr("class")]=$(this).html()});$.ajax({url:urlBase+"api/painel/entrada/inserirentrada/cadastrar",type:"post",dataType:"json",data:JSON.stringify(E),success:function(G,F){if(G.sucesso==true){a()}},error:function(H,G,F){s()}})}function e(){$("#formDataEntrada").val("");$("#formNumeroNota").val("")}function g(){$("#formItemContrato").val(0);$("#formQuantidade").val("");$("#formUnidade").empty()}function i(){$("#listaItens").empty();$("#listaVazia").show();o=0;t=true}function A(){e();g();i()}function a(){var B='<div class="row"><div class="col-md-12"><div class="text-center"><h4>Entrada cadastrada com <b>sucesso</b>.</h4></div></div></div><div class="row"><div class="col-md-2 col-md-offset-5"><button id="botaoOk" class="btn btn-success btn-block">OK</button></div></div>';$("#modalRodape").empty();$("#modalTitulo").html("Entrada Cadastrada");$("#modalCorpo").html(B);$("#botaoOk").click(function(){c();location.reload()})}function s(){$("#tituloModal").html("Confirmação de Cadastro de Saída");$("#barraProgresso").hide();$("#modalErro").modal("show")}function z(){var C="";var D=$(".item");var B=$(".quantidade");$("#confFormContrato").text($("#formContrato option:selected").text());$("#confFormNumeroNota").text($("#formNumeroNota").val());$("#confFormDataEntrada").text($("#formDataEntrada").val());$(".listaItem").each(function(F,E){C+='<div class="row"><div class="col-md-6" style="padding-right: 0;"><h5>'+$(D[F]).html()+'</h5></div><div class="col-md-6" style="padding-right: 0; padding-left: 4px;"><h5>&nbsp;&nbsp;&nbsp;'+$(B[F]).html()+"</h5></div></div>"});$("#confListaItens").html(C)}function y(){var B=$(".botaoEditar");B.off();B.each(function(C,D){$(D).click(function(){var E=$($(".idItemContrato")[C]);var F=$($(".valorQuantidade")[C]);f=C;k=true;$("#formItemContrato").val(E.html());$("#formQuantidade").val(F.html());l();$("#botaoAdicionar").attr("class","btn btn-warning btn-block");$("#botaoAdicionar").html("Edição Concluída")})})}function p(){var B=$(".botaoRemover");B.off();B.each(function(D,C){$(C).click(function(){$($(".listaItem")[D]).remove();o--;m();if(o==0){$("#listaVazia").show()}notificacao_sucesso("Item <b>removido</b> com sucesso.")})})}function m(){y();p()}function c(){g();i();$("#formContrato").val(0);$("#formDataEntrada").val("");$("#formNumeroNota").val("")}function b(){var D=false;var E=$("#formItemContrato option:selected");var C=$("#formQuantidade");if(E.val()<=0){D=true;notificacao_alerta("Selecine um <b>Item</b.")}else{if(!$.isNumeric(C.val())){D=true;notificacao_alerta("Insira um número em <b>Quantidade</b>.")}else{if(C.val().indexOf(".")>0||C.val().indexOf(",")>0){D=true;notificacao_alerta("Insira apenas valores inteiros em <b>Quantidade</b>.")}else{if(parseInt(C.val())<=0){D=true;notificacao_alerta("Insira um valor maior que 0 (zero) em <b>Quantidade</b>.")}else{$('var[class="idItemContrato"]').each(function(F,G){if($(G).html()==E.val()&&k==false){D=true;notificacao_alerta("<b>Itens iguais</b> estão sendo c adastrados. Junte suas quantidades.")}});for(var B in r){if(r.hasOwnProperty(B)&&r[B]["id_item_contrato"]==E.val()){if(parseInt(C.val())>r[B]["quantidade_faltante"]){D=true;notificacao_alerta("A <b>quantidade</b> inserida supera a quantidade contratada.");notificacao_sucesso("Quantidade restante a ser entregue: <b>"+r[B]["quantidade_faltante"]+" "+unidades[r[B]["unidade_padrao_id"]]["nome"]+"</b>");break}}}}}}}return D}function h(){var C=false;var B=$("#formDataEntrada");if($("#formContrato option:selected").val()<=0){C=true;notificacao_alerta("Selecione um <b>Contrato</b>.")}else{if($.trim($("#formNumeroNota").val())==""){C=true;notificacao_alerta("Insira o <b>Número Nota</b>.")}else{if($.trim($("#formDataEntrada").val())==""){C=true;notificacao_alerta("Insira uma <b>Data Entrada</b>.")}else{if(pegaData($("#formDataEntrada").val())>new Date()){C=true;notificacao_alerta("A <b>Data Entrada</b> não pode ser maior que a data atual.")}else{if(o<=0){C=true;notificacao_alerta("<b>Lista de Itens</b> está vazia.")}else{$.ajax({async:false,url:urlBase+"api/painel/entrada/inserirentrada/datavigencia?idContrato="+$("#formContrato option:selected").val(),type:"get",success:function(E,D){if(E.sucesso==true){var F=E.resposta;if((pegaData(B.val())>pegaData(F.data_fim))||(pegaData(B.val())<pegaData(F.data_inicio))){C=true;notificacao_alerta("A <b>Data Entrada</b> deverá pertencer ao período de vigência do contrato. Período de vigência do contrato: de <b>"+F.data_inicio+"</b> até <b>"+F.data_fim+"</b>")}}},error:function(F,E,D){C=true;notificacao_alerta("Falha na conexão com a rede.")}})}}}}}return C}function q(){var D=false;v();var B=$('var[class="idItemContrato"]');var C=$('var[class="valorQuantidade"]');B.each(function(G,F){for(var E in r){if(r.hasOwnProperty(E)&&r[E]["id_item_contrato"]==$(F).html()){if(parseInt($(C[G]).html())>parseInt(r[E]["quantidade_faltante"])){D=true;notificacao_alerta("A <b>quantidade</b> inserida para o item <b>"+r[E]["nome"]+"</b> supera a quantidade contratada.");notificacao_sucesso("Quantidade restante a ser entregue: <b>"+r[E]["quantidade_faltante"]+" "+unidades[r[E]["unidade_padrao_id"]]["nome"]+"</b>");return false}}}});return D}});